<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŒ¿åæŠ½ç­¾åŠ©æ‰‹ - å‚ä¸è€…ç«¯</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
  
  <style>
    body { font-family: 'Inter', "Microsoft YaHei", sans-serif; background-color: #f8fafc; }
    .font-christmas { font-family: 'Mountains of Christmas', cursive; }
    @keyframes snowfall {
      0% { transform: translateY(-10vh) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(360deg); }
    }
    .snowflake { position: fixed; top: -10vh; color: white; font-size: 1.5rem; user-select: none; z-index: 0; pointer-events: none; opacity: 0.6; }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom": "https://esm.sh/react-dom@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "lucide-react": "https://esm.sh/lucide-react@0.263.1",
      "canvas-confetti": "https://esm.sh/canvas-confetti@1.6.0",
      "react/": "https://esm.sh/react@^19.2.3/"
    }
  }
  </script>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { Gift, Eye, Loader2, PartyPopper, AlertCircle } from 'lucide-react';
    import confetti from 'canvas-confetti';

    // ==========================================
    // åå°é…ç½®åŒºåŸŸ
    // ==========================================
    const CONFIG = {
      eventName: "2026èµµå®¶å›¢å¹´åº¦ç¤¼ç‰©äº¤æ¢",
      participants: [
        "å‘¨æ­£", "å¾ç²¼æ¾„", "å­”å˜‰", "å¼ ç´", "å…¨è–‡", "å¾å®‰ç³", "é»„å²èª", "åˆ˜è¹", "é™ˆäºšå€©", "é—«æ™“è‹", "é™ˆçˆ±é¾™", "æäºšäº‘"
      ],
      seed: 123456
    };

    // ã€ä¿®æ­£ 2ã€‘LeanCloud åˆå§‹åŒ–æ”¾åœ¨ App å¤–éƒ¨
    AV.init({
      appId: "jmYHrSFyQzSriZk4uvRAzDzX-MdYXbMMI",
      appKey: "obcHxYOXoOhjR0DNiwf71StT",
      serverURL: "https://jmyhrsfy.api.lncldglobal.com" 
    });

    const createRandom = (seed) => {
      return () => {
        let t = (seed += 0x6D2B79F5);
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    };

    const generatePairings = (names, seed) => {
      if (names.length < 2) return {};
      const random = createRandom(seed);
      const shuffled = [...names];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      const pairings = {};
      for (let i = 0; i < shuffled.length; i++) {
        pairings[shuffled[i]] = shuffled[(i + 1) % shuffled.length];
      }
      return pairings;
    };

    const Snowfall = () => {
      const [flakes, setFlakes] = useState([]);
      useEffect(() => {
        setFlakes(Array.from({ length: 30 }).map((_, i) => ({
          id: i,
          left: `${Math.random() * 100}%`,
          delay: `${Math.random() * 5}s`,
          duration: `${5 + Math.random() * 10}s`,
          size: `${0.5 + Math.random() * 1.5}rem`
        })));
      }, []);
      return (
        <>
          {flakes.map(flake => (
            <div key={flake.id} className="snowflake" style={{
              left: flake.left,
              animation: `snowfall ${flake.duration} linear infinite`,
              animationDelay: flake.delay,
              fontSize: flake.size
            }}>â„</div>
          ))}
        </>
      );
    };

    const App = () => {
      const [userName, setUserName] = useState('');
      const [isDrawing, setIsDrawing] = useState(false);
      const [targetName, setTargetName] = useState(null);
      const [error, setError] = useState(null);
      const [displayIdx, setDisplayIdx] = useState(0);
      const timerRef = useRef(null);

      const pairingsMap = useMemo(() => generatePairings(CONFIG.participants, CONFIG.seed), []);

      // ã€æ–°å¢ã€‘ç®¡ç†å‘˜æŸ¥çœ‹è¿›åº¦åŠŸèƒ½ï¼šç½‘å€åç¼€åŠ ä¸Š ?admin=show å³å¯è§¦å‘
      useEffect(() => {
        if (window.location.search.includes('admin=show')) {
          const query = new AV.Query('DrawStatus');
          query.equalTo('event', CONFIG.eventName);
          query.limit(1000);
          query.find().then((results) => {
            const names = results.map(r => r.get('userName'));
            const uniqueNames = [...new Set(names)];
            alert(`ã€æŠ½ç­¾è¿›åº¦ã€‘\nå·²å®Œæˆï¼š${uniqueNames.length} / ${CONFIG.participants.length}\nåå•ï¼š${uniqueNames.join(', ')}`);
          }).catch(err => alert("è¯»å–è¿›åº¦å¤±è´¥ï¼Œè¯·æ£€æŸ¥ LeanCloud è®¾ç½®"));
        }
      }, []);

      const startDraw = () => {
        const trimmed = userName.trim();
        const match = CONFIG.participants.find(n => n === trimmed);
        
        if (!match) {
          setError(`åå•ä¸­æ‰¾ä¸åˆ°â€œ${trimmed}â€ï¼Œè¯·æ£€æŸ¥è¾“å…¥ã€‚`);
          return;
        }

        setError(null);
        setIsDrawing(true);
        setTargetName(pairingsMap[match]);

        // ã€æ–°å¢ã€‘ä¸ŠæŠ¥è¿›åº¦
        try {
          const DrawStatus = AV.Object.extend('DrawStatus');
          const status = new DrawStatus();
          status.set('userName', match);
          status.set('event', CONFIG.eventName);
          status.save(); 
        } catch (e) {
          console.error("è®°å½•å¤±è´¥", e);
        }

        let count = 0;
        timerRef.current = setInterval(() => {
          setDisplayIdx(Math.floor(Math.random() * CONFIG.participants.length));
          count++;
          if (count > 20) {
            clearInterval(timerRef.current);
            setIsDrawing(false);
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
          }
        }, 80);
      };

      return (
        <div className="min-h-screen relative overflow-x-hidden pb-20">
          <Snowfall />
          <nav className="p-8 flex justify-center items-center relative z-10">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-red-600 rounded-2xl flex items-center justify-center text-white shadow-xl">
                <Gift size={28} />
              </div>
              <span className="text-3xl font-christmas text-slate-800 tracking-tight">åŒ¿åæŠ½ç­¾åŠ©æ‰‹</span>
            </div>
          </nav>
          <main className="relative z-10 max-w-md mx-auto p-4">
            <div className="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-red-50">
              <div className="bg-red-600 p-10 text-center text-white relative">
                <h1 className="text-4xl font-christmas mb-2">{CONFIG.eventName}</h1>
                <p className="text-red-100 opacity-90 text-sm">è¯·è¾“å…¥å§“åæ­æ™“æ‚¨çš„æŠ½ç­¾å¯¹è±¡</p>
              </div>
              <div className="p-10">
                {!targetName || isDrawing ? (
                  <div className="space-y-6">
                    <input 
                      type="text" 
                      value={userName} 
                      onChange={(e) => { setUserName(e.target.value); setError(null); }} 
                      placeholder="æ‚¨çš„å§“å" 
                      className="w-full px-6 py-5 rounded-2xl bg-slate-50 border border-slate-200 text-center text-2xl font-bold outline-none focus:ring-4 focus:ring-red-100 transition-all placeholder:text-slate-300"
                    />
                    {error && (
                      <div className="flex items-center gap-2 text-red-500 text-sm justify-center bg-red-50 p-4 rounded-xl">
                        <AlertCircle size={18} />
                        {error}
                      </div>
                    )}
                    {isDrawing ? (
                      <div className="text-center py-6">
                        <div className="text-5xl font-bold text-slate-200 animate-pulse font-christmas mb-4">
                          {CONFIG.participants[displayIdx]}
                        </div>
                        <div className="flex justify-center items-center gap-2 text-slate-400">
                          <Loader2 className="animate-spin" size={20} />
                          æ­£åœ¨åŒ¹é…...
                        </div>
                      </div>
                    ) : (
                      <button 
                        onClick={startDraw} 
                        className="w-full py-5 bg-red-600 text-white rounded-2xl font-bold text-xl shadow-xl hover:bg-red-700 active:scale-95 transition-all flex items-center justify-center gap-2"
                      >
                        <Eye size={24} /> æ­æ™“æŠ½ç­¾ç»“æœ
                      </button>
                    )}
                  </div>
                ) : (
                  <div className="text-center space-y-8">
                    <div className="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto ring-8 ring-green-50">
                      <PartyPopper size={48} />
                    </div>
                    <div>
                      <p className="text-slate-500 text-lg mb-2">
                        <span className="font-bold text-slate-800">{userName}</span>ï¼Œæ‚¨æŠ½åˆ°çš„æ˜¯ï¼š
                      </p>
                      <div className="text-6xl font-bold text-slate-900 font-christmas py-12 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 shadow-inner">
                        {targetName}
                      </div>
                    </div>
                    <div className="bg-amber-50 p-5 rounded-2xl border border-amber-100 text-amber-800 text-sm leading-relaxed">
                      ğŸ¤« è¿™æ˜¯ä¸€ä¸ªç§˜å¯†ï¼è¯·ä¸è¦å‘Šè¯‰å…¶ä»–äººã€‚
                    </div>
                    <button 
                      onClick={() => { setTargetName(null); setUserName(''); }} 
                      className="text-slate-400 text-sm font-semibold hover:text-red-600 transition-colors"
                    >
                      è¿”å›é‡è¯•
                    </button>
                  </div>
                )}
              </div>
            </div>
            <div className="mt-10 text-center text-slate-300 text-xs space-y-1">
              <p>éšç§ä¿æŠ¤ï¼šæ‰€æœ‰é…å¯¹é€»è¾‘å‡åœ¨æœ¬åœ°æ‰§è¡Œ</p>
              <p>ç®¡ç†å‘˜å¯åœ¨æºä»£ç  CONFIG éƒ¨åˆ†ä¿®æ”¹åå•</p>
            </div>
          </main>
        </div>
      );
    };

    const container = document.getElementById('root');
    const root = createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>
