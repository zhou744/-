<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¤¼ç‰©æŠ½ç­¾ - åŒ¿åé€ç¤¼åŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', "Microsoft YaHei", sans-serif;
      background-color: #f8fafc;
    }
    .font-christmas {
      font-family: 'Mountains of Christmas', cursive;
    }
    @keyframes snowfall {
      0% { transform: translateY(-10vh) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(360deg); }
    }
    .snowflake {
      position: fixed;
      top: -10vh;
      color: white;
      font-size: 1.5rem;
      user-select: none;
      z-index: 0;
      pointer-events: none;
      opacity: 0.6;
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- ä½¿ç”¨ ESM æ¨¡å—ç›´æ¥åœ¨æµè§ˆå™¨è¿è¡Œ React -->
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "canvas-confetti": "https://esm.sh/canvas-confetti@1.6.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>

  <script type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Gift, Plus, X, Users, ChevronRight, Wand2, 
      Copy, Check, Share2, ArrowLeft, Eye, EyeOff, 
      LogOut, AlertCircle, Loader2, PartyPopper 
    } from 'lucide-react';
    import confetti from 'canvas-confetti';

    // --- UTILS: Crypto & Drawing ---
    const generateId = () => Math.random().toString(36).substr(2, 9);

    const encodeEvent = (data) => {
      try {
        const json = JSON.stringify(data);
        const base64 = btoa(encodeURIComponent(json).replace(/%([0-9A-F]{2})/g, (match, p1) => {
          return String.fromCharCode(parseInt(p1, 16));
        }));
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      } catch (e) {
        return "";
      }
    };

    const decodeEvent = (hash) => {
      if (!hash) return null;
      try {
        let base64 = hash.replace(/-/g, '+').replace(/_/g, '/');
        while (base64.length % 4) base64 += '=';
        const json = decodeURIComponent(Array.prototype.map.call(atob(base64), (c) => {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(json);
      } catch (e) {
        return null;
      }
    };

    const createRandom = (seed) => {
      return () => {
        let t = (seed += 0x6D2B79F5);
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    };

    const generateDeterministicPairings = (names, seed) => {
      if (names.length < 2) return {};
      const random = createRandom(seed);
      const shuffled = [...names];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      const pairings = {};
      for (let i = 0; i < shuffled.length; i++) {
        pairings[shuffled[i]] = shuffled[(i + 1) % shuffled.length];
      }
      return pairings;
    };

    // --- COMPONENTS ---

    const Snowfall = () => {
      const [flakes, setFlakes] = useState([]);
      useEffect(() => {
        setFlakes(Array.from({ length: 30 }).map((_, i) => ({
          id: i,
          left: `${Math.random() * 100}%`,
          delay: `${Math.random() * 5}s`,
          duration: `${5 + Math.random() * 10}s`,
          size: `${0.5 + Math.random() * 1.5}rem`
        })));
      }, []);
      return flakes.map(flake => (
        <div key={flake.id} className="snowflake" style={{
          left: flake.left,
          animation: `snowfall ${flake.duration} linear infinite`,
          animationDelay: flake.delay,
          fontSize: flake.size
        }}>â„</div>
      ));
    };

    const SetupWizard = ({ onComplete }) => {
      const [eventName, setEventName] = useState('2024 äº¤æ¢ç¤¼ç‰©æ´»åŠ¨');
      const [newName, setNewName] = useState('');
      const [participants, setParticipants] = useState([]);
      const [error, setError] = useState(null);

      const addParticipant = (e) => {
        e?.preventDefault();
        const trimmed = newName.trim();
        if (!trimmed) return;
        if (participants.some(p => p.name.toLowerCase() === trimmed.toLowerCase())) {
          setError("è¯¥å§“åå·²åœ¨åå•ä¸­ï¼");
          return;
        }
        setParticipants([...participants, { id: generateId(), name: trimmed }]);
        setNewName('');
        setError(null);
      };

      const handleFinish = () => {
        if (participants.length < 3) {
          setError("è‡³å°‘éœ€è¦ 3 åå‚ä¸è€…æ‰èƒ½è¿›è¡ŒæŠ½ç­¾ã€‚");
          return;
        }
        onComplete({ eventName, participants, createdAt: Date.now() });
      };

      return (
        <div className="max-w-2xl mx-auto p-4">
          <div className="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100">
            <div className="bg-red-600 p-8 text-white relative">
              <div className="absolute top-4 right-4 opacity-10 rotate-12"><Gift size={80} /></div>
              <h1 className="text-4xl font-christmas mb-2">ç¤¼ç‰©æŠ½ç­¾è®¾ç½®</h1>
              <p className="text-red-100">å¿«é€Ÿåˆ›å»ºæ‚¨çš„åŒ¿åé€ç¤¼æ´»åŠ¨ã€‚</p>
            </div>
            <div className="p-8">
              <div className="mb-6">
                <label className="block text-sm font-semibold text-slate-700 mb-2 uppercase">æ´»åŠ¨åç§°</label>
                <input type="text" value={eventName} onChange={(e) => setEventName(e.target.value)} className="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none text-lg font-medium" />
              </div>
              <div className="mb-6">
                <label className="block text-sm font-semibold text-slate-700 mb-2 uppercase">æ·»åŠ å‚ä¸è€… ({participants.length})</label>
                <form onSubmit={addParticipant} className="flex gap-2">
                  <input type="text" value={newName} onChange={(e) => setNewName(e.target.value)} placeholder="è¾“å…¥å‚ä¸è€…å§“å..." className="flex-1 px-4 py-3 rounded-xl border border-slate-200 outline-none" />
                  <button type="submit" className="p-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors shadow-lg"><Plus size={24} /></button>
                </form>
                {error && <p className="text-red-500 text-sm mt-2 font-medium">{error}</p>}
              </div>
              <div className="mb-8 max-h-[250px] overflow-y-auto space-y-2">
                {participants.length === 0 ? (
                  <div className="text-center py-8 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 text-slate-400">
                    <Users className="mx-auto mb-2 opacity-30" size={40} />
                    <p>è¯·å¼€å§‹æ·»åŠ åå•</p>
                  </div>
                ) : (
                  participants.map((p) => (
                    <div key={p.id} className="flex items-center justify-between bg-slate-50 p-3 rounded-xl group hover:bg-slate-100">
                      <span className="font-medium text-slate-700">{p.name}</span>
                      <button onClick={() => setParticipants(participants.filter(x => x.id !== p.id))} className="text-slate-400 hover:text-red-500"><X size={18} /></button>
                    </div>
                  ))
                )}
              </div>
              <button onClick={handleFinish} disabled={participants.length < 3} className={`w-full py-4 rounded-2xl flex items-center justify-center gap-2 font-bold text-lg transition-all shadow-xl ${participants.length >= 3 ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}>
                <Wand2 size={20} /> å¼€å§‹ç”Ÿæˆåå• <ChevronRight size={20} />
              </button>
            </div>
          </div>
        </div>
      );
    };

    const OrganizerDashboard = ({ event, onReset }) => {
      const [copied, setCopied] = useState(false);
      const shareLink = useMemo(() => {
        const rawCode = encodeEvent(event);
        const baseUrl = window.location.origin + window.location.pathname;
        return `${baseUrl}#event=${rawCode}`;
      }, [event]);

      const copyToClipboard = () => {
        navigator.clipboard.writeText(shareLink).then(() => {
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        });
      };

      return (
        <div className="max-w-2xl mx-auto p-4">
          <div className="bg-white rounded-[2.5rem] shadow-2xl p-8 md:p-12 border border-slate-100">
            <div className="text-center mb-8">
              <div className="w-16 h-16 bg-red-50 text-red-600 rounded-2xl flex items-center justify-center mx-auto mb-4 rotate-3"><Share2 size={32} /></div>
              <h2 className="text-3xl font-bold text-slate-800">ç”ŸæˆæˆåŠŸï¼</h2>
              <p className="text-slate-500 italic">â€œ{event.e}â€ å·²å°±ç»ª</p>
            </div>
            <div className="bg-slate-50 rounded-3xl p-6 border-2 border-dashed border-slate-200 mb-6">
              <p className="text-xs font-bold text-slate-400 uppercase mb-2">ä¸“å±åˆ†äº«é“¾æ¥</p>
              <div className="bg-white p-3 rounded-lg border border-slate-100 text-xs font-mono text-slate-400 break-all mb-4 max-h-24 overflow-y-auto">{shareLink}</div>
              <button onClick={copyToClipboard} className={`w-full py-4 rounded-xl font-bold transition-all shadow-lg flex items-center justify-center gap-2 ${copied ? 'bg-green-600' : 'bg-red-600 hover:bg-red-700 text-white'}`}>
                {copied ? <Check size={20} /> : <Copy size={20} />} {copied ? 'å·²å¤åˆ¶' : 'å¤åˆ¶é“¾æ¥å‘ç»™å¥½å‹'}
              </button>
            </div>
            <div className="flex items-start gap-4 p-4 bg-amber-50 rounded-2xl border border-amber-100 mb-6">
              <Gift className="shrink-0 text-amber-500" size={24} />
              <p className="text-sm text-amber-800">å‘é€æ­¤é“¾æ¥ç»™å‚ä¸è€…ï¼Œä»–ä»¬è¿›å…¥åè¾“å…¥åå­—å³å¯æŸ¥çœ‹ç»“æœã€‚æ•°æ®å·²åŠ å¯†ï¼Œåªæœ‰æœ¬äººå¯è§ã€‚</p>
            </div>
            <button onClick={onReset} className="w-full py-2 text-slate-400 hover:text-red-500 flex items-center justify-center gap-2 text-sm"><ArrowLeft size={16} /> è¿”å›ä¿®æ”¹åå•</button>
          </div>
        </div>
      );
    };

    const ParticipantDraw = ({ event }) => {
      const [userName, setUserName] = useState('');
      const [isDrawing, setIsDrawing] = useState(false);
      const [targetName, setTargetName] = useState(null);
      const [error, setError] = useState(null);
      const [displayIdx, setDisplayIdx] = useState(0);
      const timerRef = useRef(null);

      const pairingsMap = useMemo(() => generateDeterministicPairings(event.n, event.s), [event]);

      const startDraw = () => {
        const trimmed = userName.trim();
        const match = event.n.find(n => n.toLowerCase() === trimmed.toLowerCase());
        if (!match) {
          setError(`åå•ä¸­æ‰¾ä¸åˆ°â€œ${trimmed}â€ï¼Œè¯·æ£€æŸ¥æ‹¼å†™ã€‚`);
          return;
        }
        setError(null);
        setIsDrawing(true);
        setTargetName(pairingsMap[match]);

        let count = 0;
        timerRef.current = setInterval(() => {
          setDisplayIdx(Math.floor(Math.random() * event.n.length));
          count++;
          if (count > 20) {
            clearInterval(timerRef.current);
            setIsDrawing(false);
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
          }
        }, 80);
      };

      return (
        <div className="max-w-md mx-auto p-4">
          <div className="bg-white rounded-[2rem] shadow-2xl overflow-hidden border border-red-50">
            <div className="bg-red-600 p-8 text-center text-white">
              <h1 className="text-3xl font-christmas mb-2">{event.e}</h1>
              <p className="text-red-100 opacity-90 text-sm">è¯·è¾“å…¥æ‚¨çš„å§“åæŸ¥çœ‹ç»“æœ</p>
            </div>
            <div className="p-10">
              {!targetName || isDrawing ? (
                <div className="space-y-6">
                  <input type="text" value={userName} onChange={(e) => { setUserName(e.target.value); setError(null); }} placeholder="æ‚¨çš„åå­—" className="w-full px-6 py-4 rounded-xl bg-slate-50 border border-slate-200 text-center text-xl font-bold outline-none" />
                  {error && <p className="text-red-500 text-sm text-center font-medium">{error}</p>}
                  {isDrawing ? (
                    <div className="text-center py-4">
                      <div className="text-4xl font-bold text-slate-200 animate-pulse font-christmas mb-2">{event.n[displayIdx]}</div>
                      <div className="flex justify-center items-center gap-2 text-slate-400 text-sm"><Loader2 className="animate-spin" size={16} /> æ­£åœ¨åŒ¹é…...</div>
                    </div>
                  ) : (
                    <button onClick={startDraw} className="w-full py-4 bg-red-600 text-white rounded-xl font-bold text-xl shadow-lg flex items-center justify-center gap-2"><Eye size={20} /> æ­æ™“ç»“æœ</button>
                  )}
                </div>
              ) : (
                <div className="text-center space-y-6">
                  <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto ring-4 ring-green-50"><PartyPopper size={32} /></div>
                  <p className="text-slate-500"><span className="font-bold text-slate-800">{userName}</span>ï¼Œæ‚¨æŠ½åˆ°çš„æ˜¯ï¼š</p>
                  <div className="text-5xl font-bold text-slate-900 font-christmas py-8 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">{targetName}</div>
                  <p className="text-amber-600 text-xs italic">ğŸ¤« è¿™æ˜¯ä¸€ä¸ªç§˜å¯†ï¼Œè¯·ä¸è¦å‘Šè¯‰åˆ«äººï¼</p>
                  <button onClick={() => { setTargetName(null); setUserName(''); }} className="text-slate-300 text-xs hover:text-red-500">é‡æ–°è¾“å…¥</button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const App = () => {
      const [view, setView] = useState('SETUP');
      const [eventData, setEventData] = useState(null);

      useEffect(() => {
        const handleHash = () => {
          const hash = window.location.hash;
          if (hash.includes('event=')) {
            const decoded = decodeEvent(hash.split('event=')[1]);
            if (decoded) {
              setEventData(decoded);
              setView('PARTICIPANT_ENTRY');
              return;
            }
          }
          const saved = localStorage.getItem('secret_santa_v5');
          if (saved) {
            setEventData(JSON.parse(saved));
            setView('ORGANIZER_SHARE');
          } else {
            setView('SETUP');
          }
        };
        handleHash();
        window.addEventListener('hashchange', handleHash);
        return () => window.removeEventListener('hashchange', handleHash);
      }, []);

      const handleSetupComplete = (data) => {
        const shared = { e: data.eventName, n: data.participants.map(p => p.name), s: Math.floor(Math.random() * 999999) };
        localStorage.setItem('secret_santa_v5', JSON.stringify(shared));
        setEventData(shared);
        setView('ORGANIZER_SHARE');
      };

      const reset = () => {
        if(confirm("ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ")) {
          localStorage.removeItem('secret_santa_v5');
          window.location.hash = '';
          window.location.reload();
        }
      };

      return (
        <div className="min-h-screen relative overflow-x-hidden bg-[#fafafa]">
          <Snowfall />
          <nav className="p-6 flex justify-between items-center max-w-4xl mx-auto relative z-10">
            <div className="flex items-center gap-2 cursor-pointer" onClick={() => window.location.reload()}>
              <div className="w-8 h-8 bg-red-600 rounded-lg flex items-center justify-center text-white shadow-md"><Gift size={18} /></div>
              <span className="text-xl font-christmas text-slate-800">åŒ¿åæŠ½ç­¾åŠ©æ‰‹</span>
            </div>
            {view !== 'SETUP' && <button onClick={reset} className="text-xs font-bold text-slate-400 hover:text-red-500 flex items-center gap-1 bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-100"><LogOut size={12} /> é€€å‡º</button>}
          </nav>
          <main className="relative z-10 px-4">
            {view === 'SETUP' && <SetupWizard onComplete={handleSetupComplete} />}
            {view === 'ORGANIZER_SHARE' && eventData && <OrganizerDashboard event={eventData} onReset={() => { localStorage.removeItem('secret_santa_v5'); setView('SETUP'); }} />}
            {view === 'PARTICIPANT_ENTRY' && eventData && <ParticipantDraw event={eventData} />}
            {view === 'SETUP' && <p className="text-center text-slate-300 text-xs mt-8">éšç§æç¤ºï¼šæ‰€æœ‰æ•°æ®å‡åœ¨æœ¬åœ°å¤„ç†ï¼Œä¸ç»è¿‡ä»»ä½•æœåŠ¡å™¨</p>}
          </main>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>
